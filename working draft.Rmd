---
title: "Week12"
author: "Ashley Hirt, Shreya Dubey, Rakib Kamal"
date: "11/18/2019"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Library Packages

```{r}
library(data.table)
library(tidyverse)
library(viridis)
theme_set(theme_minimal())

# colors used for plotting
mygreen <- "#22908C"
mypurple <- "#450D54"
```

## Read in Data

First, we read in our data and the columns. We will also get rid of Discharge.Year because all of the years were 2016.
```{r read data}
hosp <- fread("G:/My Drive/DATA/Final Project/hospital.csv", 
              check.names=T,
              na.strings = c("", "NA")
)

hosp <- as.tibble(hosp)
# save original dataset before renaming
hosp_og <- hosp

# rename columns
colnames(hosp) <- c("Area", "County", "Certificate", "Facility.ID", "Facility.Name",
                    "Age", "Zip", "Gender", "Race", "Ethnicity", "Duration", "Type",
                    "Discharge.Status", "Discharge.Year", "CCS.Code", "CCS.Diagnosis",
                    "CCS.Procedure.Code", "CCS.Procedure", "DRG.Code", "DRG",
                    "MDC.Code", "MDC", "Severity.Code", "Severity", "Mortality.Risk",
                    "Surgical", "Payment1", "Payment2", "Payment3", "Birthweight",
                    "Abortion", "ED", "Charges", "Costs")

unique(hosp$Discharge.Year)
# get rid of discharge.year 
hosp <- hosp[,-which(colnames(hosp)=="Discharge.Year")]
```

## Examine Existing NAs
Then, we examine existing NAs. We see that, of our 2,343,429 rows, there are 1,725,198 incomplete cases. 
```{r examine existing NAs}
sum(complete.cases(hosp) == F) # 1725198 incomplete cases

# to look at the incomplete rows (assign data frame "incomplete"):
incomplete <- hosp[!complete.cases(hosp),]

# tally up the number of NAs in each column
nas <- c()
invisible(
sapply(1:ncol(incomplete), function(x) {
  nas[x] <<- sum(is.na(incomplete[,x]))
})
)
names(nas) <- colnames(incomplete)
nas # shows the number of NAs in each column
```
Area, County, Certificate, and Facility.ID have 5325 instances of NAs. They all co-occur (an NA in one of these variables corresponds to an NA in the others as well). We also see that the Facility.Name variable is always "Redacted for Confidentiality" for these instances. Presumably, this is the reason that all the location information is NAs for these records.
```{r}
unique(incomplete[is.na(incomplete$Area),]$Facility.Name)
```
Zipcode has 36215 NAs. The data dictionary states that the patient zip code will be blank (NA) for the following confidentiality reasons: zip code population size less than 20,000 people; abortion records; less than 10 records with that zip code.


Severity AND Mortality.Risk each have 67 NAs, which also co-occur. Most of these records have no diganosis under the DRG column and they have a DRG.Code greater than 952. This doesn't make sense, since the maximum DRG.Code used in New York State is 952. Thus, we assume these records had missing or invalid DRG.Codes. Since Severity and mortality.risk are derived from the DRG coding system as well, it makes sense that they would also be NAs. Also, (inexplicably), for all of these records, the CCS.Diagnosis corresponds to some type of birth that was not an abortion.
```{r}
# examine incomplete severity rows
severity.incomplete <- incomplete[is.na(incomplete$Severity),]
unique(severity.incomplete$DRG.Code)
unique(severity.incomplete$DRG)

# replace with NAs
hosp$DRG.Code <- ifelse(hosp$DRG.Code > 952, NA, hosp$DRG.Code)
```


Payment2 has 834420 NAs. Payment3 has 1691076 NAs. These correspond to people that only had one payment type, so that makes sense and requires no further investigation.


## Change Invalid Values to NAs
To identify invalid values, we look at their distributions (either a histogram for quantitative variables or bar plots for categorical variables). 
```{r}
# examine birthweight plot for strange values
ggplot(hosp, aes(x=Birthweight)) +
  geom_histogram() + 
  ggtitle("Distribution of Birthweight (g)")
```
We see that there are a large number of 0s for birthweight, which indicates that the record does not correspond to a pregnancy/birth. We replace all 0s with NAs, reexamine the birthweight plot, and see that it appears normal (as expected)

```{r}
hosp$Birthweight <- ifelse(hosp$Birthweight==0, NA, hosp$Birthweight)

# reexamine birthweight plot
ggplot(hosp, aes(x=Birthweight)) +
  geom_histogram() + 
  ggtitle("Distribution of Birthweight (g)")
# none of the birthweights appear abnormal.
```

Repeat for gender, and replace all 57 "unknown" genders with NAs. 
```{r}
# examine gender plot for unusual values
ggplot(hosp, aes(x=Gender)) + 
  geom_bar(stat="count") +
  ggtitle("Distribution of Gender")
# replace all "unknown" genders with NA
sum(hosp$Gender == "U") # only 57 records with unknown gender.
hosp$Gender <- ifelse(hosp$Gender=="U", NA, hosp$Gender)
```

Repeat for ethnicity, and replace all 97,180 "unknown" ethnicities with NAs.
```{r}
# examine ethnicity plot for unusual values
ggplot(hosp, aes(x=Ethnicity)) + 
  geom_bar(stat="count") +
  ggtitle("Distribution of Ethnicity")
# replace all "unknown" ethnicities with NA
sum(hosp$Ethnicity == "Unknown") # 97,180 records with Unknown ethnicities
hosp$Ethnicity <- ifelse(hosp$Ethnicity=="Unknown", NA, hosp$Ethnicity)
```

Repeat for surgical, and replace all 67 "Not Applicable" entries with NAs
```{r}
# examine categories
ggplot(hosp, aes(x=Surgical)) + 
  geom_bar(stat="count") +
  ggtitle("Distribution of Surgical Category")
# replace surgical "Not Applicable" entries with NA
sum(hosp$Surgical == "Not Applicable") # 67 Surgery "Not Applicable"s
hosp$Surgical <- ifelse(hosp$Surgical=="Not Applicable", NA, hosp$Surgical)
```

Repeat for Type of admission
```{r}
sum(hosp$Type=="Not Available") # 435 of these rows
hosp$Type <- ifelse(hosp$Type == "Not Available", NA, hosp$Type)
```

Repeat for discharge status.
```{r}
sum(hosp$Discharge.Status=="Another Type Not Listed")
hosp$Discharge.Status <- ifelse(hosp$Discharge.Status=="Another Type Not Listed", NA, hosp$Discharge.Status)
```

Repeat for CCS code. From the distribution, we see that categories above 650-63 and 670 represent MHSA coding (mental health codes). 917 stands for unclassified E code and 999 is ungroupable, which we will recode as NAs
```{r}
ggplot(hosp, aes(x=CCS.Code)) + geom_histogram()
table(hosp$CCS.Code[hosp$CCS.Code > 260])

#recode as NAs  
hosp$CCS.Code <- ifelse(hosp$CCS.Code==999, NA, hosp$CCS.Code)
```

Repeat for payment1, replace all 6,896 "Unknowns" with NAs. Note that we are not replacing payment2 or payment3 "Unknown" with NA because currently, NA stands for "there was not a second/third payment type" and we don't want to combine these records. Perhaps (although doubtedly) the unknown category has predictive value and should be kept separate from the other NAs. 
```{r}
# replace payment1 "Unknown" with NA
sum(hosp$Payment1 == "Unknown") #6896 Payment1 "Unknown"
hosp$Payment1 <- ifelse(hosp$Payment1=="Unknown", NA, hosp$Payment1)
```

## Examine Distributions of Variables
Next, we examine the distributions of our variables to get an idea of whether they appear appropriate.
```{r examine distributions}
ggplot(hosp, aes(x=Area)) + 
  geom_bar(stat="count") + 
  theme(axis.text.x = element_text(angle = 45, size=8)) +
  ggtitle("Distribution of Hospital Service Area")
# has an NA category, distribution looks appropriate

ggplot(hosp, aes(x=County)) + 
  geom_bar(stat="count") +
  theme(axis.text.x = element_text(angle = 90, size=8, vjust=0.2)) +
  ggtitle("Distribution of County")
# has an NA category, distribution looks appropriate
```

We examine how cerficate compares to facility.name and facility.ID (are they redundant?).
```{r}
name <- list()
id <- list()

# group by certificate, then get the unique facility name/ID with that certificate
x <- hosp %>%
  group_by(Certificate) %>%
  summarise(
    name = list(unique(Facility.Name)),
    id = list(unique(Facility.ID))
  )
x$name[c(1:10)]

```
From this, we see that there are multiple hospital names for the same certificate number, but they are typically different campuses of the same main hospital (e.g. "Albany Medical Center Hospital" and "Albany Medical Center - South Clinical Campus"). The facility ID corresponds to these campus differences. So we assume that in our classification tasks, we will not use certificate or facility.name, we'll just use facility.ID because it encapsulates the former two variables.

```{r}
# drop columns Facility.Name and Facility.ID
hosp <- hosp[,-which(colnames(hosp) %in% c("Certificate", "Facility.Name"))]

# examine distribution of facility ID
ggplot(hosp, aes(x=Facility.ID)) + 
  geom_histogram() +
  ggtitle("Distribution of Facility ID")
```
It appears unusual that some facility IDs are in the 9000s, but this is not mentioned in our data dictionary, so there is no way to know if they are valid or not.

```{r}
high.id <- filter(hosp, Facility.ID>9000)
unique(high.id$Area)
unique(high.id$Facility.Name)
```
Examination of these rows indicates there are 3,151 rows with facility.ID>9000. They all come from one of 3 hospitals: St Peter's Addiction Recovery Center, The Burdett Care Center, and Crouse Hospital - Commonwealth Division. Although their facility.ID values seem unusual, these records do appear valid, so we keep them in the dataset unchanged.

Next, we examine a distribution of age groups.
```{r}
ggplot(hosp, aes(x=Age)) + 
  geom_bar(stat="count") +
  ggtitle("Distribution of Age Group")
```
This appears normal, no NAs. Age groups 50-69, and 70+ have the highest amount of hospital discharge records, which is consistent with what is expected.

```{r}
ggplot(hosp, aes(x=Race)) + 
  geom_bar(stat="count") +
  ggtitle("Distribution of Race")
```
The distribution of race also appears normal, no NAs. Note that "other race" is explained in the data dictionary as coding for Asians, Pacific Islanders, and Native Americans.

```{r}
y <- hosp %>% group_by(Duration) %>% summarize(count = n())
ggplot(y, aes(x=as.numeric(Duration), y=count)) + 
  geom_point() +
  ggtitle("Distribution of Duration of Hospital Stay")
```
Here we see that the vast majority of Hospital durations are less than 10 days. Also, the one row that was removed was "120+" bc it is not easily coerced to numeric. We know a priori from the data dictionary that this categorization of duration stands for any duration greater than 120 days.

## Create indicator variables
For all values replaced with NAs or other abnormalities noted above, we will create indicator variables in case there is systematic missingness.
```{r}
hosp <- hosp %>%
  mutate(redacted = ifelse(is.na(hosp$Area), 1, 0),
         na.zip = ifelse(is.na(Zip), 1, 0),
         invalid.drg = ifelse(is.na(DRG.Code), 1, 0),
         na.payment1 = ifelse(Payment1=="Unknown", 1, 0),
         no.payment2 = ifelse(is.na(Payment2), 1, 0),
         unknown.payment2 = ifelse(Payment2=="Unknown", 1, 0),
         no.payment3 = ifelse(is.na(Payment3), 1, 0),
         unknown.payment3 = ifelse(Payment3 == "Unknown", 1, 0),
         if.birth = ifelse(is.na(Birthweight), 0, 1),
         na.gender = ifelse(is.na(Gender), 1, 0),
         na.ethnicity = ifelse(is.na(Ethnicity), 1, 0),
         na.surgical = ifelse(is.na(Surgical), 1, 0),
         high.id = ifelse(Facility.ID > 9000, 1, 0),
         na.type = ifelse(is.na(Type), 1, 0),
         na.discharge = ifelse(is.na(Discharge.Status), 1, 0),
         na.ccs = ifelse(is.na(CCS.Code), 1, 0),
         na.ccs.procedure = ifelse(is.na(CCS.Procedure.Code), 1, 0)
         )
```


# Test Center
```{r}
ggplot(hosp, aes(x=Type)) + geom_bar(stat="count")
ggplot(hosp, aes(x=Discharge.Status)) + geom_bar(stat="count") + theme(axis.text.x = element_text(angle=90))



# THIS STILL NEEDS TO BE ADDED IN 
ggplot(hosp, aes(x=CCS.Procedure.Code)) + geom_histogram()
# the highest CCS Procedure code is 231. 
unique(hosp[hosp$CCS.Procedure.Code>231, "CCS.Procedure.Code"])
# all the records greater than 231 are coded 999 for ungroupable, so we will make those NAs.
hosp$CCS.Procedure.Code <- ifelse(hosp$CCS.Procedure.Code==999, NA, hosp$CCS.Procedure.Code)
# there are also 0s in the procedure code, which correponds to no procedure performed. we will create an indicator variable for those later.
hosp[hosp$CCS.Procedure.Code==0, c("CCS.Procedure.Code", "CCS.Procedure")][1,]


# ADD IN
hosp$Duration <- ifelse(hosp$Duration == "120 +", 120, hosp$Duration)
hosp$Duration <- as.numeric(hosp$Duration)


# ADD IN
# 0s don't make sense for Severity.Code and correspond to the redacted rows. 
hosp$Severity.Code <- ifelse(hosp$Severity.Code==0, NA, hosp$Severity.Code)





library(corrplot)

num <- hosp[,c("Duration", "CCS.Code", "CCS.Procedure.Code", "DRG.Code", "MDC.Code", "Severity.Code", "Birthweight", "Charges", "Costs")]

x <- cor(num[complete.cases(num)==T,])
corrplot(x)
# from the corrplot, we see that DRG.Code and MDC.Code are highly correlated. This is surprising, considering that there are only 26 MDC codes which correspond to organ systems, while there are 300+ DRG Codes that represent specific diseases. We also see that there is a moderate positive correlation between Severity.Code and Duration, which makes sense since Severity.Code is on a 1-4 scale with 4 being extremely severe. Also, there is a moderate negative correalation between birthweight and Duration (again as expected, these likely represent premature babies). There is a strong positive correlation between charges and duration, as well as costs with duration and costs with charges. Finally, there is a weak negative correlation between birthweight and severity.code, a weak postivie correlation of severity.code with costs and severity.code with charges, and a weak negative association between birthweight and charges/costs.

# I am surprised to see the signifcance that birthweight has as a predictor for our other variables. Specifically, we can draw some preliminary conclusions: the lower the birthweight, the higher the duration, the higher the severity.code, and the higher the charges/costs.
births <- hosp[hosp$Birthweight>0 & !is.na(hosp$Birthweight),]
ggplot(births[!is.na(births$Severity.Code),], aes(
  x=as.factor(Severity.Code), y=Birthweight)
  ) +
  geom_boxplot(colour=mygreen)


ggplot(births, aes(x=Birthweight, y=Duration)) + 
  geom_point(alpha=.3)


# make all non-numeric columns into factors
num.index <- c()
for (i in 1:length(colnames(num))) {
  num.index[i] <- which(colnames(num)[i] == colnames(hosp))
}
factor.index <- (1:ncol(hosp))[-num.index]
apply(hosp[,factor.index], 2, as.factor)

```